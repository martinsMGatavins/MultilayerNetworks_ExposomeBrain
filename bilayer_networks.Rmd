---
title: "Bilayer_networks_structural_functional"
author: "Martins M Gatavins & Ivan L Simpson-Kent"
date: "2023-04-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# R version 4.2.3
# RStudio
library(readr) # v 2.1.4
library(dplyr) # v 1.1.1
library(stringi) # v 1.7.12
library(stringr) # v 1.5.0
library(tidyr) # 1.3.0
library(corrplot) # v 0.92
library(qgraph) # v 1.9.4
library(psychonetrics) # v 0.10
library(networktools) # v 1.5.0
library(Matrix) # v 1.5.3
library(OpenMx) # v 2.21.1
library(bootnet) # v 1.5
#library(NetworkComparisonTest) # v 2.2.1
library(reshape2) # v 1.4.4
library(lavaan) # v 0.6-15
library(semPlot)
library(jmv)
library(psych)
```
# SETUP
Load structural (*n=167*) and functional (*n=131*) data and set up working directory

```{r}
workdir <- "~/Desktop/exposome_project/"
load(paste0(workdir,"n190_funcStructExposomedata.RData"))
structural_data <- joint_quest[joint_quest[["structural"]]==1,]
functional_data <- joint_quest[joint_quest[["functional"]]==1,]
```

Group variables by modality (exposome, structural, functional) and submodality (structural: surface area and cortical thickness; functional: participation and clustering coefficient)

```{r}
exposome <- colnames(joint_quest)[3:16]
communities <- c("Vis","Motor","DorAtt","VenAtt","Limb","Contr","Defau")
PCvars <- paste(communities,"PC",sep="_")
CCvars <- paste(communities,"CC",sep="_")
SAvars <- paste(communities,"SA",sep="")
CTvars <- paste(communities,"CT",sep="")
```

Data prep for network modeling

```{r}
PC_exposome_df <- functional_data[,c(exposome,paste0(PCvars,"_resid"))]
CC_exposome_df <- functional_data[,c(exposome,paste0(CCvars,"_resid"))]
SA_exposome_df <- structural_data[,c(exposome,SAvars)]
CT_exposome_df <- structural_data[,c(exposome,CTvars)]

colnames(PC_exposome_df) <- gsub("_PC_resid","",colnames(PC_exposome_df))
colnames(CC_exposome_df) <- gsub("_CC_resid","",colnames(CC_exposome_df))
colnames(SA_exposome_df) <- gsub("SA","",colnames(SA_exposome_df))
colnames(CT_exposome_df) <- gsub("CT","",colnames(CT_exposome_df))

set.seed(125) # for replication
```

Setting up organization elements for plots

```{r}
exposomeColors<-c("white","white","white","white","white","white","white",
                  "white",'white',"white","white","white","white","white",
                  "grey","grey","grey","grey","grey","grey","grey")
modalities <- c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2)
```

# Network modeling - FUNCTIONAL MEASURES

Unthresholded exposome-participation coefficient bilayer networks
(1) Model
```{r}
exposomePC_unthresholded <- estimateNetwork(PC_exposome_df,
                                   corMethod="cor",
                                   corArgs=list(method="pearson",
                                                use="pairwise.complete.obs"),
                                   default="EBICglasso",
                                   tuning=0.5,
                                   threshold=F)

```
(2) Plot 
```{r}
plot(exposomePC_unthresholded,color = exposomeColors,layout="spring",fade=T,
     posCol=c("#386E4B"),negCol=c("#9D0080"),negDashed=T)
```
(3) Correlation stability test (range: ~ 0.435, 0.359-0.519)
```{r}
exposomePC_unthresholded_boot <- bootnet(PC_exposome_df,
                                         corMethod = "cor", 
                      corArgs = list(method = "pearson",
                                     use = "pairwise.complete.obs"),
                      default = "EBICglasso",
                      tuning = 0.5,
                      nCores = 8,
                      nBoots = 2000,
                      type = "case", 
                      statistics = c("edge"),
                      communities = modalities)
corStability(exposomePC_unthresholded_boot)
```
(4) Second correlation stability test (+/- 0.2; CS = 0.504)
```{r}
exposomePC_unthresholded_boot_precise <- bootnet(PC_exposome_df,
                                         corMethod = "cor", 
                      corArgs = list(method = "pearson",
                                     use = "pairwise.complete.obs"),
                      default = "EBICglasso",
                      tuning = 0.5,
                      nCores = 8,
                      nBoots = 2000,
                      type = "case", 
                      statistics = c("edge"),
                      caseMin = 0.235, caseMax = 0.635,
                      communities = modalities)
corStability(exposomePC_unthresholded_boot_precise)
```
(5) Descriptive statistics (incomplete)
```{r}
exposomePC_unthresholded[["graph"]]["Lead","Defau"] # -0.04
exposomePC_unthresholded_lowerDiag <- matrix(vechs(getWmat(exposomePC_unthresholded[["graph"]])))
nnzero(vechs(getWmat(exposomePC_unthresholded[["graph"]]))) # 58
sum(vechs(getWmat(exposomePC_unthresholded[["graph"]])) < 0) # 14
mean(replace(exposomePC_unthresholded_lowerDiag,
             exposomePC_unthresholded_lowerDiag==0,
             NA),na.rm=T) # 0.276
sd(replace(exposomePC_unthresholded_lowerDiag,
             exposomePC_unthresholded_lowerDiag==0,
             NA),na.rm=T) # 0.44
range(replace(exposomePC_unthresholded_lowerDiag,
             exposomePC_unthresholded_lowerDiag==0,
             NA),na.rm=T) # 0-1

nnzero(vechs(exposomePC_unthresholded[["graph"]][c(1:14),c(15:21)])) # 1
sum(vechs(exposomePC_unthresholded[["graph"]][c(1:14),c(15:21)]) < 0) # 1
```

Thresholded exposome-participation coefficient bilayer networks
(1) Model
```{r}
exposomePC_thresholded <- estimateNetwork(PC_exposome_df,
                                   corMethod="cor",
                                   corArgs=list(method="pearson",
                                                use="pairwise.complete.obs"),
                                   default="EBICglasso",
                                   tuning=0.5,
                                   threshold=T)
```
(2) Plot 
```{r}
plot(exposomePC_thresholded,color = exposomeColors,layout="spring",fade=T,
     posCol=c("#386E4B"),negCol=c("#9D0080"),negDashed=T)
```
(3) Correlation stability test (estimated CS = 0.435)
```{r}
exposomePC_thresholded_boot <- bootnet(PC_exposome_df,
                                         corMethod = "cor", 
                      corArgs = list(method = "pearson",
                                     use = "pairwise.complete.obs"),
                      default = "EBICglasso",
                      tuning = 0.5,
                      threshold=T,
                      nCores = 8,
                      nBoots = 2000,
                      type = "case", 
                      statistics = c("edge"),
                      communities = modalities)
corStability(exposomePC_unthresholded_boot)
```
(4) Second correlation stability test (+/- 0.2; CS = 0.550)
```{r}
exposomePC_thresholded_boot_precise <- bootnet(PC_exposome_df,
                                         corMethod = "cor", 
                      corArgs = list(method = "pearson",
                                     use = "pairwise.complete.obs"),
                      default = "EBICglasso",
                      tuning = 0.5,
                      threshold=T,
                      nCores = 8,
                      nBoots = 2000,
                      caseMin = 0.235, caseMax = 0.635,
                      type = "case", 
                      statistics = c("edge"),
                      communities = modalities)
corStability(exposomePC_thresholded_boot_precise)

```
(5) Descriptive statistics (incomplete)
```{r}
exposomePC_thresholded[["graph"]]["Lead","Defau"] # -0.20
exposomePC_thresholded_lowerDiag <- matrix(vechs(getWmat(exposomePC_thresholded[["graph"]])))
nnzero(vechs(getWmat(exposomePC_thresholded[["graph"]]))) # 24
sum(vechs(getWmat(exposomePC_thresholded[["graph"]]))<0) # 24
mean(replace(exposomePC_thresholded_lowerDiag,
             exposomePC_thresholded_lowerDiag==0,
             NA),na.rm=T) # 0.276
sd(replace(exposomePC_thresholded_lowerDiag,
             exposomePC_thresholded_lowerDiag==0,
             NA),na.rm=T) # 0.44
range(replace(exposomePC_thresholded_lowerDiag,
             exposomePC_thresholded_lowerDiag==0,
             NA),na.rm=T) # 0-1

nnzero(vechs(exposomePC_thresholded[["graph"]][c(1:14),c(15:21)])) # 1
sum(vechs(exposomePC_thresholded[["graph"]][c(1:14),c(15:21)]) < 0) # 1
```

Unthresholded exposome-clustering coefficient bilayer networks
(1) Model
```{r}
exposomeCC_unthresholded <- estimateNetwork(CC_exposome_df,
                                   corMethod="cor",
                                   corArgs=list(method="pearson",
                                                use="pairwise.complete.obs"),
                                   default="EBICglasso",
                                   tuning=0.5,
                                   threshold=F)

```
(2) Plot - figure XX
```{r}
plot(exposomeCC_unthresholded,color = exposomeColors,layout="spring",fade=T,
     posCol=c("#386E4B"),negCol=c("#9D0080"),negDashed=T)
```
(3) Correlation stability test (estimated CS = 0.519)
```{r}
exposomeCC_unthresholded_boot <- bootnet(CC_exposome_df,
                                         corMethod = "cor", 
                      corArgs = list(method = "pearson",
                                     use = "pairwise.complete.obs"),
                      default = "EBICglasso",
                      tuning = 0.5,
                      threshold=F,
                      nCores = 8,
                      nBoots = 2000,
                      type = "case", 
                      statistics = c("edge"),
                      communities = modalities)
corStability(exposomeCC_unthresholded_boot)
```
(4) Second correlation stability test (+/- 0.2; CS = 0.542)
```{r}
exposomeCC_unthresholded_boot_precise <- bootnet(CC_exposome_df,
                                         corMethod = "cor", 
                      corArgs = list(method = "pearson",
                                     use = "pairwise.complete.obs"),
                      default = "EBICglasso",
                      tuning = 0.5,
                      threshold=F,
                      nCores = 8,
                      nBoots = 2000,
                      caseMin = 0.319, caseMax = 0.719,
                      type = "case", 
                      statistics = c("edge"),
                      communities = modalities)
corStability(exposomeCC_unthresholded_boot_precise)
```
(5) Descriptive statistics (incomplete)
```{r}
exposomeCC_unthresholded[["graph"]]["Lead","Defau"] # 0.04
exposomeCC_unthresholded[["graph"]]["PartMatt","Contr"] # 0.04

exposomeCC_unthresholded_lowerDiag <- matrix(vechs(getWmat(exposomeCC_unthresholded[["graph"]])))
nnzero(vechs(getWmat(exposomeCC_unthresholded[["graph"]]))) # 24
sum(vechs(getWmat(exposomeCC_unthresholded[["graph"]]))<0) # 24
mean(replace(exposomeCC_unthresholded_lowerDiag,
             exposomeCC_unthresholded_lowerDiag==0,
             NA),na.rm=T) # 0.276
sd(replace(exposomeCC_unthresholded_lowerDiag,
             exposomeCC_unthresholded_lowerDiag==0,
             NA),na.rm=T) # 0.44
range(replace(exposomeCC_unthresholded_lowerDiag,
             exposomeCC_unthresholded_lowerDiag==0,
             NA),na.rm=T) # 0-1

nnzero(vechs(exposomeCC_unthresholded[["graph"]][c(1:14),c(15:21)])) # 1
sum(vechs(exposomeCC_unthresholded[["graph"]][c(1:14),c(15:21)]) < 0) # 1
```

Thresholded exposome-clustering coefficient bilayer networks
(1) Model
```{r}
exposomeCC_thresholded <- estimateNetwork(CC_exposome_df,
                                   corMethod="cor",
                                   corArgs=list(method="pearson",
                                                use="pairwise.complete.obs"),
                                   default="EBICglasso",
                                   tuning=0.5,
                                   threshold=T)

```
(2) Plot 
```{r}
plot(exposomeCC_thresholded,color = exposomeColors,layout="spring",fade=T,
     posCol=c("#386E4B"),negCol=c("#9D0080"),negDashed=T)
```
(3) Correlation stability test (estimated CS = 0.595)
```{r}
exposomeCC_thresholded_boot <- bootnet(CC_exposome_df,
                                         corMethod = "cor", 
                      corArgs = list(method = "pearson",
                                     use = "pairwise.complete.obs"),
                      default = "EBICglasso",
                      tuning = 0.5,
                      threshold=T,
                      nCores = 8,
                      nBoots = 2000,
                      type = "case", 
                      statistics = c("edge"),
                      communities = modalities)
corStability(exposomeCC_thresholded_boot)
```
(4) Second correlation stability test (+/- 0.2; CS = 0.573)
```{r}
exposomeCC_thresholded_boot_precise <- bootnet(CC_exposome_df,
                                         corMethod = "cor", 
                      corArgs = list(method = "pearson",
                                     use = "pairwise.complete.obs"),
                      default = "EBICglasso",
                      tuning = 0.5,
                      threshold=T,
                      nCores = 8,
                      nBoots = 2000,
                      caseMin = 0.395, caseMax = 0.795,
                      type = "case", 
                      statistics = c("edge"),
                      communities = modalities)
corStability(exposomeCC_thresholded_boot_precise)
```
(5) Descriptive statistics (incomplete)
```{r}
exposomeCC_thresholded_lowerDiag <- matrix(vechs(getWmat(exposomeCC_thresholded[["graph"]])))
nnzero(vechs(getWmat(exposomeCC_thresholded[["graph"]]))) # 24
sum(vechs(getWmat(exposomeCC_thresholded[["graph"]]))<0) # 24
mean(replace(exposomeCC_thresholded_lowerDiag,
             exposomeCC_thresholded_lowerDiag==0,
             NA),na.rm=T) # 0.276
sd(replace(exposomeCC_thresholded_lowerDiag,
             exposomeCC_thresholded_lowerDiag==0,
             NA),na.rm=T) # 0.44
range(replace(exposomeCC_thresholded_lowerDiag,
             exposomeCC_thresholded_lowerDiag==0,
             NA),na.rm=T) # 0-1

nnzero(vechs(exposomeCC_thresholded[["graph"]][c(1:14),c(15:21)])) # 1
sum(vechs(exposomeCC_thresholded[["graph"]][c(1:14),c(15:21)]) < 0) # 1
```


# Network modeling - STRUCTURAL MEASURES
```{r}

```
